name: ğŸ  Scraper NieruchomoÅ›ci

on:
  # Uruchamianie co 6 godzin
  schedule:
    - cron: '0 */6 * * *'
  
  # MoÅ¼liwoÅ›Ä‡ rÄ™cznego uruchomienia
  workflow_dispatch:
    inputs:
      max_pages:
        description: 'Maksymalna liczba stron do scrapowania (0 = wszystkie)'
        required: false
        default: '5'
        type: string
      batch_size:
        description: 'Rozmiar batcha do zapisu'
        required: false
        default: '100'
        type: string
      scraping_only:
        description: 'Tylko scrapowanie bez geocodingu'
        required: false
        default: false
        type: boolean
      no_details:
        description: 'PomiÅ„ szczegÃ³Å‚owy scraping'
        required: false
        default: false
        type: boolean

jobs:
  scraper:
    name: ğŸ” Uruchom Scraper
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Environment variables dostÄ™pne dla wszystkich krokÃ³w
    env:
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    
    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0
        
      - name: ğŸ› ï¸ SprawdÅº strukturÄ™ repozytorium
        run: |
          echo "ğŸ“ Sprawdzenie struktury repozytorium po checkout..."
          echo "ğŸ  Katalog gÅ‚Ã³wny:"
          ls -la
          echo ""
          echo "ğŸ“‚ Sprawdzenie katalogu scripts:"
          if [ -d "scripts" ]; then
            echo "âœ… Katalog scripts/ istnieje"
            ls -la scripts/
          else
            echo "âŒ BRAK katalogu scripts/"
            echo "ğŸ” Sprawdzamy commit SHA:"
            git rev-parse HEAD
            echo "ğŸ” Sprawdzamy wszystkie pliki w repo:"
            git ls-tree -r HEAD | grep scripts || echo "âŒ Brak plikÃ³w scripts w tree"
          fi
        
      - name: ğŸ” Validate secrets
        env:
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        run: |
          echo "ğŸ” Sprawdzanie sekretÃ³w..."
          
          missing_secrets=()
          
          if [ -z "$MYSQL_HOST" ]; then missing_secrets+=("MYSQL_HOST"); fi
          if [ -z "$MYSQL_PORT" ]; then missing_secrets+=("MYSQL_PORT"); fi
          if [ -z "$MYSQL_USER" ]; then missing_secrets+=("MYSQL_USER"); fi
          if [ -z "$MYSQL_PASSWORD" ]; then missing_secrets+=("MYSQL_PASSWORD"); fi
          if [ -z "$MYSQL_DATABASE" ]; then missing_secrets+=("MYSQL_DATABASE"); fi
          
          if [ ${#missing_secrets[@]} -ne 0 ]; then
            echo "âŒ BrakujÄ…ce sekrety: ${missing_secrets[*]}"
            echo "ğŸ’¡ Skonfiguruj je w Settings > Secrets and variables > Actions"
            exit 1
          else
            echo "âœ… Wszystkie wymagane sekrety sÄ… skonfigurowane"
          fi
          
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ğŸ“¦ Zainstaluj Chrome dla Selenium
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
          
      - name: ğŸ“¦ Zainstaluj ChromeDriver
        uses: nanasess/setup-chromedriver@v2
        
      - name: ğŸ“ SprawdÅº wersje przeglÄ…darek
        run: |
          google-chrome --version
          chromedriver --version
          
      - name: ğŸ“¦ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: ğŸ”§ Zainstaluj system dependencies dla MySQL
        run: |
          sudo apt-get update
          sudo apt-get install -y default-libmysqlclient-dev build-essential pkg-config
          
      - name: ğŸ“¦ Zainstaluj zaleÅ¼noÅ›ci Python
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # SprawdÅº requirements.txt
          echo "ğŸ“‹ ZawartoÅ›Ä‡ requirements.txt:"
          if [ -f requirements.txt ]; then
            cat requirements.txt
          else
            echo "âŒ Brak pliku requirements.txt!"
            exit 1
          fi
          
          # Zainstaluj WSZYSTKIE podstawowe zaleÅ¼noÅ›ci rÄ™cznie w pierwszej kolejnoÅ›ci
          echo "ğŸ”§ Instalowanie kluczowych zaleÅ¼noÅ›ci..."
          pip install requests==2.31.0
          pip install beautifulsoup4==4.12.2
          pip install selenium==4.16.0
          pip install lxml==4.9.3
          pip install python-dotenv==1.0.0
          pip install pandas==2.1.4
          
          # MySQL connectory
          echo "ğŸ”§ Instalowanie mysql-connector-python..."
          pip install mysql-connector-python==8.2.0
          
          echo "ğŸ”§ Instalowanie PyMySQL jako backup..."
          pip install PyMySQL==1.1.0
          
          # Test importÃ³w podstawowych pakietÃ³w
          echo "ğŸ” Test importÃ³w kluczowych pakietÃ³w..."
          python -c "
          import sys
          print(f'ğŸ Python version: {sys.version}')
          
          packages_to_test = [
              ('requests', 'requests'),
              ('beautifulsoup4', 'bs4'),
              ('selenium', 'selenium'),
              ('lxml', 'lxml'),
              ('python-dotenv', 'dotenv'),
              ('pandas', 'pandas'),
              ('mysql.connector', 'mysql.connector'),
              ('pymysql', 'pymysql')
          ]
          
          failed_imports = []
          for package_name, import_name in packages_to_test:
              try:
                  __import__(import_name)
                  print(f'âœ… {package_name}: OK')
              except ImportError as e:
                  print(f'âŒ {package_name}: FAILED - {e}')
                  failed_imports.append(package_name)
              except Exception as e:
                  print(f'âŒ {package_name}: ERROR - {e}')
                  failed_imports.append(package_name)
          
          if failed_imports:
              print(f'ğŸ’¥ BÅ‚Ä™dne importy: {failed_imports}')
              exit(1)
          else:
              print('âœ… Wszystkie kluczowe pakiety zainstalowane poprawnie!')
          "
          
          # Zainstaluj pozostaÅ‚e zaleÅ¼noÅ›ci z requirements.txt
          echo "ğŸ”§ Instalowanie pozostaÅ‚ych zaleÅ¼noÅ›ci z requirements.txt..."
          for i in {1..3}; do
            if pip install -r requirements.txt; then
              echo "âœ… PozostaÅ‚e zaleÅ¼noÅ›ci zainstalowane pomyÅ›lnie"
              break
            else
              echo "âŒ PrÃ³ba $i instalacji requirements.txt nie powiodÅ‚a siÄ™, ponawianie..."
              sleep 5
            fi
          done
          
          # Final test wszystkich pakietÃ³w
          echo "ğŸ“¦ Finalne sprawdzenie wszystkich zainstalowanych pakietÃ³w:"
          pip list
          
          echo ""
          echo "ğŸ” Ostatni test importÃ³w przed uruchomieniem scrapera:"
          python -c "
          print('Testing final imports...')
          try:
              import requests
              import bs4
              import selenium
              import mysql.connector
              import pymysql
              import pandas
              import dotenv
              print('âœ… Wszystkie importy dziaÅ‚ajÄ… poprawnie!')
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d finalnego testu: {e}')
              exit(1)
          "
          
      - name: ğŸ”§ Przygotuj plik Å›rodowiska
        env:
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        run: |
          cat > .env << EOF
          MYSQL_HOST=${MYSQL_HOST}
          MYSQL_PORT=${MYSQL_PORT}
          MYSQL_USER=${MYSQL_USER}
          MYSQL_PASSWORD=${MYSQL_PASSWORD}
          MYSQL_DATABASE=${MYSQL_DATABASE}
          
          SCRAPER_DELAY_MIN=2
          SCRAPER_DELAY_MAX=5
          MAX_RETRIES=3
          USE_HEADLESS=true
          
          LOG_LEVEL=INFO
          LOG_TO_FILE=true
          LOG_FILE=scraper.log
          
          ENABLE_GEOCODING=true
          ENABLE_RATE_LIMITING=true
          MAX_PAGES_PER_SESSION=20
          ROTATE_USER_AGENTS=true
          EOF
          echo "âœ… Plik .env utworzony pomyÅ›lnie"
          
      - name: ğŸ§ª Test poÅ‚Ä…czenia z bazÄ… danych
        env:
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        run: |
          python3 -c "
          import os
          import sys
          
          print('ğŸ” Test poÅ‚Ä…czenia z bazÄ… MySQL...')
          print(f'ğŸ¢ Host: {os.environ.get(\"MYSQL_HOST\", \"not_set\")}')
          print(f'ğŸ”Œ Port: {os.environ.get(\"MYSQL_PORT\", \"not_set\")}')
          print(f'ğŸ‘¤ User: {os.environ.get(\"MYSQL_USER\", \"not_set\")}')
          print(f'ğŸ—„ï¸ Database: {os.environ.get(\"MYSQL_DATABASE\", \"not_set\")}')
          
          # SprÃ³buj rÃ³Å¼ne connektory MySQL
          connection_successful = False
          
          # Pierwsza prÃ³ba: mysql.connector
          try:
              import mysql.connector
              print('ğŸ“¦ UÅ¼ywam mysql.connector...')
              
              conn = mysql.connector.connect(
                  host=os.environ['MYSQL_HOST'],
                  port=int(os.environ['MYSQL_PORT']),
                  user=os.environ['MYSQL_USER'],
                  password=os.environ['MYSQL_PASSWORD'],
                  database=os.environ['MYSQL_DATABASE']
              )
              print('âœ… PoÅ‚Ä…czenie z MySQL: OK (mysql.connector)')
              connection_successful = True
              
          except ImportError:
              print('âŒ mysql.connector nie jest dostÄ™pny')
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d mysql.connector: {e}')
          
          # Druga prÃ³ba: PyMySQL jako backup
          if not connection_successful:
              try:
                  import pymysql
                  print('ğŸ“¦ UÅ¼ywam PyMySQL jako backup...')
                  
                  conn = pymysql.connect(
                      host=os.environ['MYSQL_HOST'],
                      port=int(os.environ['MYSQL_PORT']),
                      user=os.environ['MYSQL_USER'],
                      password=os.environ['MYSQL_PASSWORD'],
                      database=os.environ['MYSQL_DATABASE']
                  )
                  print('âœ… PoÅ‚Ä…czenie z MySQL: OK (PyMySQL)')
                  connection_successful = True
                  
              except ImportError:
                  print('âŒ PyMySQL nie jest dostÄ™pny')
              except Exception as e:
                  print(f'âŒ BÅ‚Ä…d PyMySQL: {e}')
          
          if connection_successful:
              cursor = conn.cursor()
              cursor.execute('SELECT VERSION()')
              version = cursor.fetchone()[0]
              print(f'ğŸ“Š MySQL version: {version}')
              
              # Test tabeli
              cursor.execute(\"SHOW TABLES LIKE 'nieruchomosci'\")
              result = cursor.fetchone()
              table_exists = result is not None
              if table_exists:
                  print('âœ… Tabela nieruchomosci: EXISTS')
              else:
                  print('âš ï¸ Tabela nieruchomosci: NOT FOUND')
              
              conn.close()
          else:
              print('âŒ Nie udaÅ‚o siÄ™ poÅ‚Ä…czyÄ‡ z bazÄ… danych Å¼adnym connektorem')
              
              # SprawdÅº dostÄ™pne pakiety
              import pkg_resources
              installed_packages = [d.project_name for d in pkg_resources.working_set]
              mysql_packages = [p for p in installed_packages if 'mysql' in p.lower()]
              print(f'ğŸ“¦ Zainstalowane pakiety MySQL: {mysql_packages}')
              
              exit(1)
          "
          
      - name: ğŸ” Uruchom scraper
        env:
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        run: |
          echo "ğŸ“ Katalog roboczy przed zmianÄ…: $(pwd)"
          echo "ğŸ” Git information:"
          echo "   SHA: $(git rev-parse HEAD)"
          echo "   Branch: $(git branch --show-current)"
          echo "   Remote: $(git remote get-url origin)"
          
          echo ""
          echo "ğŸ“‹ ZawartoÅ›Ä‡ katalogu scripts:"
          ls -la scripts/ || echo "âŒ Brak katalogu scripts"
          
          echo ""
          echo "ğŸ“‚ Debug: Sprawdzenie drzewa git dla scripts:"
          git ls-tree HEAD scripts/ || echo "âŒ Brak scripts/ w git tree"
          
          # SprawdÅº czy scraper_main.py istnieje
          if [ -f "scripts/scraper_main.py" ]; then
            echo "âœ… Znaleziono scripts/scraper_main.py"
          else
            echo "âŒ Nie znaleziono scripts/scraper_main.py"
            echo "ğŸ“ ZawartoÅ›Ä‡ gÅ‚Ã³wnego katalogu:"
            ls -la
            echo ""
            echo "ğŸ” Sprawdzanie wszystkich plikÃ³w Python:"
            find . -name "*.py" -type f | head -20
            echo ""
            echo "ğŸ” Sprawdzanie czy scripts/ jest w .gitignore:"
            if [ -f .gitignore ]; then
              grep -n scripts .gitignore || echo "âŒ scripts nie jest w .gitignore"
            else
              echo "âŒ Brak .gitignore"
            fi
            exit 1
          fi
          
          cd scripts
          echo "ğŸ“ Zmieniono katalog na: $(pwd)"
          
          # Final test importÃ³w w kontekÅ›cie scrapera
          echo "ğŸ” Test importÃ³w w katalogu scripts przed uruchomieniem:"
          python -c "
          import sys
          import os
          
          # Dodaj gÅ‚Ã³wny katalog do path
          sys.path.insert(0, os.path.dirname(os.getcwd()))
          
          print(f'Python path: {sys.path[:3]}...')
          
          try:
              import requests
              print('âœ… requests: OK')
          except Exception as e:
              print(f'âŒ requests: {e}')
              
          try:
              import bs4
              print('âœ… beautifulsoup4: OK')
          except Exception as e:
              print(f'âŒ beautifulsoup4: {e}')
              
          try:
              import selenium
              print('âœ… selenium: OK')
          except Exception as e:
              print(f'âŒ selenium: {e}')
              
          try:
              import mysql.connector
              print('âœ… mysql.connector: OK')
          except Exception as e:
              print(f'âŒ mysql.connector: {e}')
              
          try:
              from utils import get_soup
              print('âœ… utils.get_soup: OK')
          except Exception as e:
              print(f'âŒ utils.get_soup: {e}')
              
          try:
              from src.scrapers.otodom_scraper import get_otodom_listings
              print('âœ… otodom_scraper: OK')
          except Exception as e:
              print(f'âŒ otodom_scraper: {e}')
          "
          
          # Przygotuj parametry na podstawie inputÃ³w
          PARAMS=""
          
          # UÅ¼yj domyÅ›lnych wartoÅ›ci jeÅ›li input nie zostaÅ‚ podany
          MAX_PAGES="${{ github.event.inputs.max_pages || '5' }}"
          BATCH_SIZE="${{ github.event.inputs.batch_size || '100' }}"
          
          PARAMS="--pages ${MAX_PAGES} --batch-size ${BATCH_SIZE}"
          
          if [ "${{ github.event.inputs.scraping_only }}" == "true" ]; then
            PARAMS="$PARAMS --scraping-only"
          fi
          
          if [ "${{ github.event.inputs.no_details }}" == "true" ]; then
            PARAMS="$PARAMS --no-details"
          fi
          
          echo "ğŸš€ Uruchamiam scraper z parametrami: $PARAMS"
          echo "ğŸ Python version: $(python --version)"
          echo "âš™ï¸ Environment check:"
          echo "   MYSQL_HOST: ${MYSQL_HOST:-'not_set'}"
          echo "   MYSQL_DATABASE: ${MYSQL_DATABASE:-'not_set'}"
          
          # Test importÃ³w przed uruchomieniem
          echo "ğŸ” Final import test przed uruchomieniem scrapera:"
          python -c "
          try:
              import requests
              print('âœ… requests: OK')
          except ImportError as e:
              print(f'âŒ requests: FAILED - {e}')
              exit(1)
              
          try:
              from src.scrapers.otodom_scraper import get_otodom_listings
              print('âœ… otodom_scraper: OK')
          except ImportError as e:
              print(f'âŒ otodom_scraper: FAILED - {e}')
              exit(1)
              
          print('âœ… Wszystkie importy dziaÅ‚ajÄ… poprawnie')
          "
          
          python scraper_main.py $PARAMS
          
      - name: ğŸ“Š PokaÅ¼ statystyki koÅ„cowe
        if: always()
        env:
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        run: |
          python3 -c "
          import os
          
          print('ğŸ” Pobieranie statystyk koÅ„cowych...')
          
          # SprÃ³buj rÃ³Å¼ne connektory MySQL
          connection_successful = False
          
          # Pierwsza prÃ³ba: mysql.connector
          try:
              import mysql.connector
              print('ğŸ“¦ UÅ¼ywam mysql.connector...')
              
              conn = mysql.connector.connect(
                  host=os.environ['MYSQL_HOST'],
                  port=int(os.environ['MYSQL_PORT']),
                  user=os.environ['MYSQL_USER'],
                  password=os.environ['MYSQL_PASSWORD'],
                  database=os.environ['MYSQL_DATABASE']
              )
              print('âœ… PoÅ‚Ä…czenie z MySQL: OK (mysql.connector)')
              connection_successful = True
              
          except ImportError:
              print('âŒ mysql.connector nie jest dostÄ™pny')
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d mysql.connector: {e}')
          
          # Druga prÃ³ba: PyMySQL jako backup
          if not connection_successful:
              try:
                  import pymysql
                  print('ğŸ“¦ UÅ¼ywam PyMySQL jako backup...')
                  
                  conn = pymysql.connect(
                      host=os.environ['MYSQL_HOST'],
                      port=int(os.environ['MYSQL_PORT']),
                      user=os.environ['MYSQL_USER'],
                      password=os.environ['MYSQL_PASSWORD'],
                      database=os.environ['MYSQL_DATABASE']
                  )
                  print('âœ… PoÅ‚Ä…czenie z MySQL: OK (PyMySQL)')
                  connection_successful = True
                  
              except ImportError:
                  print('âŒ PyMySQL nie jest dostÄ™pny')
              except Exception as e:
                  print(f'âŒ BÅ‚Ä…d PyMySQL: {e}')
          
          if connection_successful:
              cursor = conn.cursor()
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci')
              total = cursor.fetchone()[0]
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 DAY)')
              today = cursor.fetchone()[0]
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 HOUR)')
              last_hour = cursor.fetchone()[0]
              
              # Dodatkowe statystyki
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE price IS NOT NULL')
              with_price = cursor.fetchone()[0]
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE latitude IS NOT NULL')
              geocoded = cursor.fetchone()[0]
              
              print(f'ğŸ“Š ÅÄ…cznie w bazie: {total:,} ogÅ‚oszeÅ„')
              print(f'ğŸ†• Dodane dzisiaj: {today:,} ogÅ‚oszeÅ„')
              print(f'â° Ostatnia godzina: {last_hour:,} ogÅ‚oszeÅ„')
              print(f'ğŸ’° Z cenami: {with_price:,} ogÅ‚oszeÅ„ ({with_price/max(total,1)*100:.1f}%)')
              print(f'ğŸŒ Geocoded: {geocoded:,} ogÅ‚oszeÅ„ ({geocoded/max(total,1)*100:.1f}%)')
              
              conn.close()
          else:
              print('âŒ Nie udaÅ‚o siÄ™ poÅ‚Ä…czyÄ‡ z bazÄ… danych - statystyki niedostÄ™pne')
              print('â„¹ï¸ MoÅ¼e to byÄ‡ oczekiwane jeÅ›li scraper siÄ™ nie udaÅ‚ lub baza jest niedostÄ™pna')
          "
          
      - name: ğŸ“‹ Upload logÃ³w
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            scraper.log
            scripts/scraper.log
          retention-days: 7
          
      - name: ğŸ’¬ Powiadomienie o bÅ‚Ä™dzie (Slack/Discord)
        if: failure()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then
            echo "ğŸ“¢ WysyÅ‚am powiadomienie o bÅ‚Ä™dzie..."
            curl -X POST $WEBHOOK_URL \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "âŒ Scraper nieruchomoÅ›ci: BÅ‚Ä…d podczas wykonania\nğŸ”— Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }'
          else
            echo "â„¹ï¸ Brak konfiguracji WEBHOOK_URL - pomijam powiadomienie"
          fi
            
  notify-success:
    name: ğŸ“¢ Powiadomienie o sukcesie
    needs: scraper
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: success()
    
    env:
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“¦ Zainstaluj MySQL connector
        run: |
          pip install mysql-connector-python PyMySQL python-dotenv
        
      - name: ğŸ“Š Pobierz statystyki
        id: stats
        run: |
          cat > get_stats.py << 'EOF'
          import os
          from datetime import datetime
          
          # Debug informacje
          print("ğŸ” PrÃ³ba poÅ‚Ä…czenia z bazÄ… danych...")
          
          # SprÃ³buj rÃ³Å¼ne connektory MySQL
          connection_successful = False
          conn = None
          
          # Pierwsza prÃ³ba: mysql.connector
          try:
              import mysql.connector
              print('ğŸ“¦ UÅ¼ywam mysql.connector...')
              
              conn = mysql.connector.connect(
                  host='${{ secrets.MYSQL_HOST }}',
                  port=int('${{ secrets.MYSQL_PORT }}'),
                  user='${{ secrets.MYSQL_USER }}',
                  password='${{ secrets.MYSQL_PASSWORD }}',
                  database='${{ secrets.MYSQL_DATABASE }}'
              )
              print("âœ… PoÅ‚Ä…czenie z MySQL: OK (mysql.connector)")
              connection_successful = True
              
          except ImportError:
              print('âŒ mysql.connector nie jest dostÄ™pny')
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d mysql.connector: {e}')
          
          # Druga prÃ³ba: PyMySQL jako backup
          if not connection_successful:
              try:
                  import pymysql
                  print('ğŸ“¦ UÅ¼ywam PyMySQL jako backup...')
                  
                  conn = pymysql.connect(
                      host='${{ secrets.MYSQL_HOST }}',
                      port=int('${{ secrets.MYSQL_PORT }}'),
                      user='${{ secrets.MYSQL_USER }}',
                      password='${{ secrets.MYSQL_PASSWORD }}',
                      database='${{ secrets.MYSQL_DATABASE }}'
                  )
                  print("âœ… PoÅ‚Ä…czenie z MySQL: OK (PyMySQL)")
                  connection_successful = True
                  
              except ImportError:
                  print('âŒ PyMySQL nie jest dostÄ™pny')
              except Exception as e:
                  print(f'âŒ BÅ‚Ä…d PyMySQL: {e}')
          
          if connection_successful:
              try:
                  cursor = conn.cursor()
              
              # Statystyki podstawowe
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci')
              total = cursor.fetchone()[0]
              print(f"ğŸ“Š PobraÅ‚em total: {total}")
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 DAY)')
              today = cursor.fetchone()[0]
              print(f"ğŸ“Š PobraÅ‚em today: {today}")
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE updated_at >= DATE_SUB(NOW(), INTERVAL 1 HOUR)')
              last_hour = cursor.fetchone()[0]
              print(f"ğŸ“Š PobraÅ‚em last_hour: {last_hour}")
              
              # Statystyki jakoÅ›ci danych
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE price IS NOT NULL')
              with_price = cursor.fetchone()[0]
              print(f"ğŸ“Š PobraÅ‚em with_price: {with_price}")
              
              cursor.execute('SELECT COUNT(*) FROM nieruchomosci WHERE latitude IS NOT NULL')
              geocoded = cursor.fetchone()[0]
              print(f"ğŸ“Š PobraÅ‚em geocoded: {geocoded}")
              
              # Outputs dla GitHub Actions
              print(f"TOTAL={total}")
              print(f"TODAY={today}")
              print(f"LAST_HOUR={last_hour}")
              print(f"WITH_PRICE={with_price}")
              print(f"GEOCODED={geocoded}")
              
                  conn.close()
                  print("âœ… Statystyki pobrane pomyÅ›lnie")
                  
              except Exception as e:
                  print(f"âŒ BÅ‚Ä…d podczas pobierania statystyk: {e}")
                  if conn:
                      conn.close()
                  # DomyÅ›lne wartoÅ›ci w przypadku bÅ‚Ä™du
                  print("TOTAL=0")
                  print("TODAY=0") 
                  print("LAST_HOUR=0")
                  print("WITH_PRICE=0")
                  print("GEOCODED=0")
                  print(f"ERROR={e}")
          else:
              print("âŒ Nie udaÅ‚o siÄ™ poÅ‚Ä…czyÄ‡ z bazÄ… danych")
              # DomyÅ›lne wartoÅ›ci w przypadku bÅ‚Ä™du poÅ‚Ä…czenia
              print("TOTAL=0")
              print("TODAY=0") 
              print("LAST_HOUR=0")
              print("WITH_PRICE=0")
              print("GEOCODED=0")
              print("ERROR=Connection failed")
          EOF
          
          echo "ğŸš€ Uruchamiam skrypt pobierania statystyk..."
          python get_stats.py >> $GITHUB_OUTPUT
          
      - name: ğŸ’¬ WyÅ›lij powiadomienie o sukcesie
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then
            echo "ğŸ“¢ WysyÅ‚am powiadomienie o sukcesie..."
            curl -X POST $WEBHOOK_URL \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "âœ… Scraper nieruchomoÅ›ci: ZakoÅ„czony pomyÅ›lnie\nğŸ“Š ÅÄ…cznie: ${{ steps.stats.outputs.TOTAL }} ogÅ‚oszeÅ„\nğŸ†• Dodane dzisiaj: ${{ steps.stats.outputs.TODAY }}\nâ° Ostatnia godzina: ${{ steps.stats.outputs.LAST_HOUR }}\nğŸ’° Z cenami: ${{ steps.stats.outputs.WITH_PRICE }}\nğŸŒ Geocoded: ${{ steps.stats.outputs.GEOCODED }}\nğŸ”— SzczegÃ³Å‚y: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }'
          else
            echo "â„¹ï¸ Brak konfiguracji WEBHOOK_URL - pomijam powiadomienie"
          fi
