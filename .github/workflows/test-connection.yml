name: ğŸ§ª Test PoÅ‚Ä…czenia z BazÄ…

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Poziom debugowania'
        required: false
        default: 'basic'
        type: choice
        options:
          - basic
          - detailed
          - full

jobs:
  test-connection:
    name: ğŸ”— Test MySQL Connection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“¦ Zainstaluj podstawowe zaleÅ¼noÅ›ci
        run: |
          python -m pip install --upgrade pip
          pip install mysql-connector-python python-dotenv
          
      - name: ğŸ”§ SprawdÅº Å›rodowisko
        run: |
          echo "ğŸ“ Katalog roboczy: $(pwd)"
          echo "ğŸ Python version: $(python --version)"
          echo "ğŸ“‹ ZawartoÅ›Ä‡ gÅ‚Ã³wnego katalogu:"
          ls -la
          echo ""
          echo "ğŸ“‹ Pliki .py w gÅ‚Ã³wnym katalogu:"
          ls -la *.py || echo "Brak plikÃ³w .py"
          
      - name: ğŸ”§ Przygotuj plik Å›rodowiska
        run: |
          cat > .env << EOF
          MYSQL_HOST=${{ secrets.MYSQL_HOST }}
          MYSQL_PORT=${{ secrets.MYSQL_PORT }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          EOF
          echo "âœ… Plik .env utworzony"
          
      - name: ğŸ§ª Test podstawowy - bezpoÅ›rednie poÅ‚Ä…czenie
        run: |
          python3 -c "
          import mysql.connector
          import os
          
          print('ğŸ” Test bezpoÅ›redniego poÅ‚Ä…czenia MySQL...')
          
          try:
              conn = mysql.connector.connect(
                  host='${{ secrets.MYSQL_HOST }}',
                  port=int('${{ secrets.MYSQL_PORT }}'),
                  user='${{ secrets.MYSQL_USER }}',
                  password='${{ secrets.MYSQL_PASSWORD }}',
                  database='${{ secrets.MYSQL_DATABASE }}'
              )
              print('âœ… BezpoÅ›rednie poÅ‚Ä…czenie: OK')
              
              cursor = conn.cursor()
              cursor.execute('SELECT VERSION()')
              version = cursor.fetchone()[0]
              print(f'ğŸ“Š MySQL version: {version}')
              
              cursor.execute('SELECT DATABASE()')
              db_name = cursor.fetchone()[0]
              print(f'ğŸ“Š Database: {db_name}')
              
              conn.close()
              
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d bezpoÅ›redniego poÅ‚Ä…czenia: {e}')
              exit(1)
          "
          
      - name: ğŸ§ª Test przez mysql_utils (jeÅ›li istnieje)
        run: |
          python3 -c "
          import sys
          import os
          
          # Dodaj gÅ‚Ã³wny katalog do Å›cieÅ¼ki Python
          sys.path.insert(0, os.getcwd())
          
          print('ğŸ” Test poÅ‚Ä…czenia przez mysql_utils...')
          print(f'ğŸ“ Python path: {sys.path[0]}')
          
          # SprawdÅº czy plik istnieje
          if os.path.exists('mysql_utils.py'):
              print('âœ… Plik mysql_utils.py istnieje')
          else:
              print('âŒ Plik mysql_utils.py nie istnieje')
              print('ğŸ“‹ Pliki .py w katalogu:')
              for f in os.listdir('.'):
                  if f.endswith('.py'):
                      print(f'   {f}')
              exit(1)
          
          try:
              from mysql_utils import get_mysql_connection
              print('âœ… Import mysql_utils: OK')
              
              conn = get_mysql_connection()
              print('âœ… PoÅ‚Ä…czenie przez mysql_utils: OK')
              conn.close()
              
          except ImportError as e:
              print(f'âŒ BÅ‚Ä…d importu: {e}')
              exit(1)
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d poÅ‚Ä…czenia: {e}')
              exit(1)
          "
          
      - name: ğŸ” Test tabeli nieruchomosci
        if: github.event.inputs.debug_level == 'detailed' || github.event.inputs.debug_level == 'full'
        run: |
          python3 -c "
          import mysql.connector
          
          print('ğŸ” Test tabeli nieruchomosci...')
          
          try:
              conn = mysql.connector.connect(
                  host='${{ secrets.MYSQL_HOST }}',
                  port=int('${{ secrets.MYSQL_PORT }}'),
                  user='${{ secrets.MYSQL_USER }}',
                  password='${{ secrets.MYSQL_PASSWORD }}',
                  database='${{ secrets.MYSQL_DATABASE }}'
              )
              cursor = conn.cursor()
              
              # SprawdÅº czy tabela istnieje
              cursor.execute(\"SHOW TABLES LIKE 'nieruchomosci'\")
              table_exists = cursor.fetchone() is not None
              
              if table_exists:
                  print('âœ… Tabela nieruchomosci istnieje')
                  
                  cursor.execute('SELECT COUNT(*) FROM nieruchomosci')
                  count = cursor.fetchone()[0]
                  print(f'ğŸ“Š RekordÃ³w w tabeli: {count:,}')
                  
                  # SprawdÅº strukturÄ™ tabeli
                  cursor.execute('DESCRIBE nieruchomosci')
                  columns = cursor.fetchall()
                  print(f'ğŸ“‹ Kolumn w tabeli: {len(columns)}')
                  
                  if '${{ github.event.inputs.debug_level }}' == 'full':
                      print('ğŸ“‹ Struktura tabeli:')
                      for col in columns[:10]:  # PokaÅ¼ pierwszych 10 kolumn
                          print(f'   {col[0]} - {col[1]}')
                      if len(columns) > 10:
                          print(f'   ... i {len(columns) - 10} wiÄ™cej')
              else:
                  print('âŒ Tabela nieruchomosci nie istnieje')
                  print('ğŸ“‹ DostÄ™pne tabele:')
                  cursor.execute('SHOW TABLES')
                  tables = cursor.fetchall()
                  for table in tables:
                      print(f'   {table[0]}')
              
              conn.close()
              
          except Exception as e:
              print(f'âŒ BÅ‚Ä…d sprawdzania tabeli: {e}')
          "
          
      - name: ğŸ‰ Podsumowanie
        if: always()
        run: |
          echo "âœ… Test poÅ‚Ä…czenia zakoÅ„czony"
          echo "ğŸ’¡ JeÅ›li wszystko przeszÅ‚o pomyÅ›lnie, gÅ‚Ã³wny workflow powinien dziaÅ‚aÄ‡"
          echo "ğŸ”— MoÅ¼esz teraz uruchomiÄ‡ gÅ‚Ã³wny scraper workflow" 